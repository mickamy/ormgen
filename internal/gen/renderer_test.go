package gen_test

import (
	"go/parser"
	"go/token"
	"strings"
	"testing"

	"github.com/mickamy/ormgen/internal/gen"
)

func TestRenderUser(t *testing.T) {
	t.Parallel()

	info, err := gen.Parse(testdataPath("user.go"), "User")
	if err != nil {
		t.Fatalf("Parse: %v", err)
	}
	info.TableName = "users"

	src, err := gen.Render(info)
	if err != nil {
		t.Fatalf("Render: %v", err)
	}

	code := string(src)

	// Verify it's valid Go
	fset := token.NewFileSet()
	if _, err := parser.ParseFile(fset, "user_gen.go", src, 0); err != nil {
		t.Fatalf("generated code does not parse: %v\n%s", err, code)
	}

	// Check key patterns
	checks := []string{
		"// Code generated by ormgen; DO NOT EDIT.",
		"package testdata",
		"func Users(db orm.Querier) *orm.Query[User]",
		`"users"`,
		"usersColumns",
		"scanUser",
		"userColumnValuePairs",
		"setUserPK",
		`case "id":`,
		`case "name":`,
		`case "created_at":`,
		"dest[i] = &v.ID",
		"dest[i] = &v.CreatedAt",
		"v.ID = int(id)",
	}
	for _, want := range checks {
		if !strings.Contains(code, want) {
			t.Errorf("missing %q in generated code:\n%s", want, code)
		}
	}
}

func TestRenderPost(t *testing.T) {
	t.Parallel()

	info, err := gen.Parse(testdataPath("user.go"), "Post")
	if err != nil {
		t.Fatalf("Parse: %v", err)
	}
	info.TableName = "posts"

	src, err := gen.Render(info)
	if err != nil {
		t.Fatalf("Render: %v", err)
	}

	code := string(src)

	fset := token.NewFileSet()
	if _, err := parser.ParseFile(fset, "post_gen.go", src, 0); err != nil {
		t.Fatalf("generated code does not parse: %v\n%s", err, code)
	}

	checks := []string{
		"func Posts(db orm.Querier) *orm.Query[Post]",
		"postsColumns",
		"scanPost",
		"postColumnValuePairs",
		"setPostPK",
	}
	for _, want := range checks {
		if !strings.Contains(code, want) {
			t.Errorf("missing %q in generated code:\n%s", want, code)
		}
	}
}

func TestRenderNoPK(t *testing.T) {
	t.Parallel()

	info, err := gen.Parse(testdataPath("no_pk.go"), "NoPK")
	if err != nil {
		t.Fatalf("Parse: %v", err)
	}
	info.TableName = "no_pks"

	_, err = gen.Render(info)
	if err == nil {
		t.Fatal("expected error for no primary key, got nil")
	}
}
